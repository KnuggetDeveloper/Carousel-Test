<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carousel Prompt Tester</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #151515;
        color: #fff;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #ff6b35;
      }

      .section {
        background: #313130;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #ff6b35;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-number {
        background: #ff6b35;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        background: #1f1f1f;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 12px;
        color: #fff;
        font-family: "Courier New", monospace;
        font-size: 13px;
        resize: vertical;
        margin-bottom: 10px;
      }

      textarea:focus {
        outline: none;
        border-color: #ff6b35;
      }

      .transcript-input {
        min-height: 200px;
      }

      button {
        background: #ff6b35;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover:not(:disabled) {
        background: #ff8c42;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      }

      button:disabled {
        background: #555;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #ff6b35;
        font-weight: 500;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #444;
        border-top-color: #ff6b35;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #ff4444;
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }

      .success-message {
        background: #44ff44;
        color: #000;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-weight: 600;
      }

      .info-box {
        background: #2a2a2a;
        border-left: 4px solid #ff6b35;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-size: 13px;
        color: #ccc;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .field-label {
        display: block;
        color: #ff6b35;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .field-label-top {
        margin-top: 0;
      }

      .field-label-spacing {
        margin-top: 20px;
      }

      .status-box {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #444;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .download-btn {
        background: #44ff44;
        color: #000;
        margin-top: 15px;
        width: 100%;
      }

      .download-btn:hover:not(:disabled) {
        background: #66ff66;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé® Carousel Prompt Tester</h1>

      <!-- Step 1: Generate Content -->
      <div class="section">
        <div class="section-title">
          <span class="section-number">1</span>
          Generate Slide Content (Text)
        </div>
        <div class="info-box">
          This prompt generates the slide structure (headings + explanations)
          from your transcript.
        </div>

        <label class="field-label field-label-top">
          üìù Transcript (Required)
        </label>
        <textarea
          id="transcript"
          class="transcript-input"
          placeholder="Paste your video transcript here..."
        ></textarea>

        <label class="field-label field-label-spacing">
          üéØ Content Generation Prompt (REQUIRED)
        </label>
        <textarea
          id="contentPrompt"
          placeholder="Enter your prompt for content generation (REQUIRED)

Example:
Generate detailed notes from this transcript.
Create 8-12 slides with format:

Slide [N]
Heading: [Title]
Explanation: [Details]

Transcript: {transcript}

Note: Use {transcript} as placeholder - it will be replaced automatically."
        ></textarea>

        <div class="button-group">
          <button onclick="generateContent()" id="generateContentBtn">
            Generate Slide Content
          </button>
          <button onclick="loadSampleTranscript()" style="background: #2a2a2a">
            Load Sample Transcript
          </button>
        </div>
        <div
          id="contentLoading"
          class="loading"
          style="display: none; margin-top: 10px"
        >
          <div class="spinner"></div>
          <span>Generating slide content...</span>
        </div>
        <div
          id="contentError"
          class="error-message"
          style="display: none"
        ></div>
        <div
          id="contentSuccess"
          class="success-message"
          style="display: none"
        ></div>
      </div>

      <!-- Step 2: Generate First Image -->
      <div class="section">
        <div class="section-title">
          <span class="section-number">2</span>
          Generate First Slide Image
        </div>
        <div class="info-box">
          This prompt generates the FIRST slide image (establishes the
          style/design).
        </div>
        <label class="field-label field-label-top">
          üé® First Image Generation Prompt (REQUIRED)
        </label>
        <textarea
          id="firstImagePrompt"
          placeholder="Enter your prompt for first image generation (REQUIRED)

Example:
Generate a professional infographic about {heading}

Content: {explanation}

Style: Modern, clean, with icons. Orange accent (#ff6b35).

Note: Use {heading} and {explanation} as placeholders - they will be replaced automatically."
        ></textarea>

        <button onclick="generateFirstImage()" id="generateFirstBtn" disabled>
          Generate First Slide Image
        </button>
        <div
          id="firstLoading"
          class="loading"
          style="display: none; margin-top: 10px"
        >
          <div class="spinner"></div>
          <span>Generating first image...</span>
        </div>
        <div id="firstError" class="error-message" style="display: none"></div>
        <div
          id="firstSuccess"
          class="success-message"
          style="display: none"
        ></div>
      </div>

      <!-- Step 3: Generate Remaining Images -->
      <div class="section">
        <div class="section-title">
          <span class="section-number">3</span>
          Generate Remaining Slide Images (with style reference)
        </div>
        <div class="info-box">
          This prompt generates all remaining slides using the first image as a
          style reference.
        </div>
        <label class="field-label field-label-top">
          üñºÔ∏è Remaining Images Prompt (REQUIRED)
        </label>
        <textarea
          id="remainingImagesPrompt"
          placeholder="Enter your prompt for remaining images generation (REQUIRED)

Example:
Generate image for {heading} matching reference style EXACTLY.

Content: {explanation}

Use same colors, fonts, layout as reference image. Only change text.

Note: Use {heading} and {explanation} as placeholders - they will be replaced automatically."
        ></textarea>

        <button
          onclick="generateRemainingImages()"
          id="generateRemainingBtn"
          disabled
        >
          Generate Remaining Images
        </button>
        <div
          id="remainingLoading"
          class="loading"
          style="display: none; margin-top: 10px"
        >
          <div class="spinner"></div>
          <span>Generating remaining images...</span>
        </div>
        <div
          id="remainingError"
          class="error-message"
          style="display: none"
        ></div>
        <div
          id="remainingSuccess"
          class="success-message"
          style="display: none"
        ></div>
      </div>

      <!-- Status Display -->
      <div class="section">
        <div class="section-title">Generation Status</div>
        <div id="statusContainer" class="status-box">
          <div class="status-item">
            <span>Slides Generated:</span>
            <span id="slidesCount">0</span>
          </div>
          <div class="status-item">
            <span>Images Generated:</span>
            <span id="imagesCount">0</span>
          </div>
        </div>
        <button
          onclick="downloadAllImages()"
          id="downloadBtn"
          class="download-btn"
          style="display: none"
        >
          üì• Download All Images
        </button>
      </div>
    </div>

    <script>
      let slides = [];
      let firstImageUrl = null;
      let generatedImages = [];

      console.log("‚úÖ Page loaded successfully");

      function loadSampleTranscript() {
        const sampleTranscript = `Welcome to today's discussion about artificial intelligence and its impact on modern business. In this session, we'll explore how AI is revolutionizing various industries and what it means for the future of work.

First, let's talk about automation. AI-powered automation is transforming manufacturing, logistics, and even service industries.`;

        document.getElementById("transcript").value = sampleTranscript;

        const successDiv = document.getElementById("contentSuccess");
        successDiv.textContent = "‚úÖ Sample transcript loaded!";
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }

      async function generateContent() {
        const transcript = document.getElementById("transcript").value.trim();
        const prompt = document.getElementById("contentPrompt").value.trim();

        if (!transcript) {
          alert("Please enter a transcript");
          return;
        }

        console.log("\n========================================");
        console.log("üìã STEP 1: CONTENT GENERATION");
        console.log("========================================");
        console.log("üìù Original Prompt (with placeholders):");
        console.log(prompt);
        console.log("\nüìÑ Transcript Length:", transcript.length, "characters");

        const btn = document.getElementById("generateContentBtn");
        const loading = document.getElementById("contentLoading");
        const errorDiv = document.getElementById("contentError");
        const successDiv = document.getElementById("contentSuccess");

        btn.disabled = true;
        loading.style.display = "flex";
        errorDiv.style.display = "none";
        successDiv.style.display = "none";

        try {
          const response = await fetch("/api/generate-content", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, transcript }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.error || data.message || "Failed to generate content"
            );
          }

          slides = data.slides;
          firstImageUrl = null;
          generatedImages = [];

          console.log("\n‚úÖ SLIDES GENERATED:", slides.length);
          slides.forEach((slide, index) => {
            console.log(`\nüìä SLIDE ${slide.slideNumber}`);
            console.log(`   üìå Heading: ${slide.heading}`);
            console.log(`   üìù Explanation: ${slide.explanation}`);
          });
          console.log("========================================\n");

          successDiv.textContent = `‚úÖ Generated ${slides.length} slides! Check console for details.`;
          successDiv.style.display = "block";

          document.getElementById("slidesCount").textContent = slides.length;
          document.getElementById("generateFirstBtn").disabled = false;
        } catch (error) {
          console.error("‚ùå Error:", error);
          errorDiv.textContent = error.message;
          errorDiv.style.display = "block";
        } finally {
          btn.disabled = false;
          loading.style.display = "none";
        }
      }

      async function generateFirstImage() {
        if (slides.length === 0) {
          alert("Please generate slide content first");
          return;
        }

        const prompt = document.getElementById("firstImagePrompt").value.trim();
        const firstSlide = slides[0];

        console.log("\n========================================");
        console.log("üé® STEP 2: FIRST IMAGE GENERATION");
        console.log("========================================");
        console.log("üìù Original Prompt (with placeholders):");
        console.log(prompt);
        console.log("\nüîÑ Prompt will be sent with:");
        console.log(`   {heading} ‚Üí "${firstSlide.heading}"`);
        console.log(
          `   {explanation} ‚Üí "${firstSlide.explanation.substring(0, 100)}..."`
        );

        const btn = document.getElementById("generateFirstBtn");
        const loading = document.getElementById("firstLoading");
        const errorDiv = document.getElementById("firstError");
        const successDiv = document.getElementById("firstSuccess");

        btn.disabled = true;
        loading.style.display = "flex";
        errorDiv.style.display = "none";
        successDiv.style.display = "none";

        try {
          const response = await fetch("/api/generate-first-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt,
              heading: firstSlide.heading,
              explanation: firstSlide.explanation,
              slideNumber: firstSlide.slideNumber,
              totalSlides: slides.length,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.error || data.message || "Failed to generate first image"
            );
          }

          firstImageUrl = data.imageUrl;
          generatedImages.push({
            slideNumber: firstSlide.slideNumber,
            imageUrl: data.imageUrl,
            heading: firstSlide.heading,
          });

          console.log("\n‚úÖ First Image Generated:");
          console.log(`   üìÅ File: ${data.imageUrl}`);
          console.log(`   üéØ Tokens: ${data.tokens.total}`);
          console.log("========================================\n");

          successDiv.textContent = `‚úÖ First image generated! (${data.tokens.total} tokens)`;
          successDiv.style.display = "block";

          document.getElementById("imagesCount").textContent =
            generatedImages.length;
          document.getElementById("generateRemainingBtn").disabled = false;
        } catch (error) {
          console.error("‚ùå Error:", error);
          errorDiv.textContent = error.message;
          errorDiv.style.display = "block";
        } finally {
          btn.disabled = false;
          loading.style.display = "none";
        }
      }

      async function generateRemainingImages() {
        if (!firstImageUrl) {
          alert("Please generate the first image first");
          return;
        }

        const prompt = document
          .getElementById("remainingImagesPrompt")
          .value.trim();
        const remainingSlides = slides.slice(1);

        if (remainingSlides.length === 0) {
          alert("No remaining slides to generate");
          return;
        }

        console.log("\n========================================");
        console.log("üñºÔ∏è  STEP 3: REMAINING IMAGES GENERATION");
        console.log("========================================");
        console.log("üìù Original Prompt (with placeholders):");
        console.log(prompt);
        console.log(
          `\nüéØ Generating ${remainingSlides.length} images with reference to first image`
        );

        const btn = document.getElementById("generateRemainingBtn");
        const loading = document.getElementById("remainingLoading");
        const errorDiv = document.getElementById("remainingError");
        const successDiv = document.getElementById("remainingSuccess");

        btn.disabled = true;
        loading.style.display = "flex";
        errorDiv.style.display = "none";
        successDiv.style.display = "none";

        try {
          const response = await fetch("/api/generate-remaining-images", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt,
              slides: remainingSlides,
              firstImageUrl,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.error ||
                data.message ||
                "Failed to generate remaining images"
            );
          }

          data.results.forEach((result, index) => {
            if (result.status === "completed") {
              const slide = remainingSlides.find(
                (s) => s.slideNumber === result.slideNumber
              );
              generatedImages.push({
                slideNumber: result.slideNumber,
                imageUrl: result.imageUrl,
                heading: slide.heading,
              });

              console.log(`\n‚úÖ Slide ${result.slideNumber} Generated:`);
              console.log(`   üìÅ File: ${result.imageUrl}`);
              console.log(`   üéØ Tokens: ${result.tokens.total}`);
            } else {
              console.log(
                `\n‚ùå Slide ${result.slideNumber} Failed:`,
                result.error
              );
            }
          });

          const successCount = data.results.filter(
            (r) => r.status === "completed"
          ).length;
          const totalTokens = data.results.reduce(
            (sum, r) => sum + (r.tokens?.total || 0),
            0
          );

          console.log("\n========================================");
          console.log(
            `‚úÖ COMPLETED: ${successCount}/${remainingSlides.length} images`
          );
          console.log(`üéØ Total Tokens: ${totalTokens}`);
          console.log("========================================\n");

          successDiv.textContent = `‚úÖ Generated ${successCount}/${remainingSlides.length} images! (${totalTokens} tokens)`;
          successDiv.style.display = "block";

          document.getElementById("imagesCount").textContent =
            generatedImages.length;

          if (generatedImages.length > 0) {
            document.getElementById("downloadBtn").style.display = "block";
          }
        } catch (error) {
          console.error("‚ùå Error:", error);
          errorDiv.textContent = error.message;
          errorDiv.style.display = "block";
        } finally {
          btn.disabled = false;
          loading.style.display = "none";
        }
      }

      async function downloadAllImages() {
        console.log("\nüì• Downloading all images...");

        for (const img of generatedImages) {
          try {
            const response = await fetch(img.imageUrl);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `slide-${img.slideNumber}-${img.heading
              .substring(0, 30)
              .replace(/[^a-z0-9]/gi, "-")}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            console.log(`‚úÖ Downloaded: Slide ${img.slideNumber}`);

            // Small delay between downloads
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            console.error(
              `‚ùå Failed to download slide ${img.slideNumber}:`,
              error
            );
          }
        }

        console.log("\n‚úÖ All downloads completed!\n");
      }
    </script>
  </body>
</html>
